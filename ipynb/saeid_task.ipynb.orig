{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 6,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "The autoreload extension is already loaded. To reload it, use:\n",
      "  %reload_ext autoreload\n"
     ]
    }
   ],
   "source": [
    "import sys\n",
    "import datetime as dt\n",
    "from pathlib import Path\n",
    "from collections import OrderedDict\n",
    "import math\n",
    "\n",
    "import requests\n",
    "import gtfstk as gt\n",
    "from highcharts import Highchart \n",
    "\n",
    "DIR = Path('..')\n",
    "sys.path.append(str(DIR))\n",
    "from transit_reliability import *\n",
    "\n",
    "%load_ext autoreload\n",
    "%autoreload 2\n",
    "\n",
    "TESTS_DIR = DIR/'tests'/'data'\n",
    "DATA_DIR = DIR/'data'/'auckland'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "metadata": {
    "collapsed": false
   },
   "outputs": [],
   "source": [
    "date = '20160519'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "metadata": {
    "collapsed": false
   },
   "outputs": [],
   "source": [
    "# Load GTFS feed to access scheduling data\n",
    "feed = gt.read_gtfs(DATA_DIR/'auckland_gtfs_20160519.zip', dist_units_in='km') # Good from 20160519\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "metadata": {
    "collapsed": false
   },
   "outputs": [],
   "source": [
    "def interpolate_delays(augmented_stop_times, dist_threshold, delay_col='delay', num_decimals=0):\n",
    "    \"\"\"\n",
    "    Given a data frame of GTFS stop times with an accurate \n",
    "    ``'shape_dist_traveled'`` column and an extra column \n",
    "    ``delay_col`` of stop time delays, interpolate the delays of each \n",
    "    trip as follows.\n",
    "    If a trip has all null delays, then leave them as is.\n",
    "    Otherwise:\n",
    "\n",
    "    - If the first delay is more than ``dist_threshold`` distance units from the \n",
    "      first stop, then set the first stop delay to zero; otherwise\n",
    "      set the first stop delay to the first delay.\n",
    "    - If the last delay is more than ``dist_threshold`` distance units from the \n",
    "      last stop, then set the last stop delay to zero; otherwise \n",
    "      set the last stop delay to the last delay.\n",
    "    - Linearly interpolate the remaining stop delays by distance.\n",
    "\n",
    "    Round all delays to the given number of decimal places.\n",
    "    If ``num_decimals is None``, then don't round. \n",
    "    Return the resulting data frame.\n",
    "    \"\"\"\n",
    "    f = augmented_stop_times.copy()\n",
    "    if delay_col not in f.columns:\n",
    "        return f\n",
    "\n",
    "    def fill(group):\n",
    "        # Don't fill trip with all null delays\n",
    "        if group[delay_col].count() == 0:\n",
    "            return group\n",
    "\n",
    "        # Set first and last delays\n",
    "        for i in [0, -1]:\n",
    "            j = group[delay_col].dropna().index[i]\n",
    "            dist_diff = abs(group['shape_dist_traveled'].iat[i] -\\\n",
    "              group['shape_dist_traveled'].ix[j])\n",
    "            if dist_diff > dist_threshold:\n",
    "                group[delay_col].iat[i] = 0\n",
    "            else:\n",
    "                group[delay_col].iat[i] = group[delay_col].ix[j]\n",
    "\n",
    "        # Interpolate remaining delays\n",
    "        ind = np.where(group[delay_col].notnull())[0]\n",
    "        group[delay_col] = np.interp(group['shape_dist_traveled'], \n",
    "          group.iloc[ind]['shape_dist_traveled'], \n",
    "          group.iloc[ind][delay_col])\n",
    "\n",
    "        return group \n",
    "\n",
    "    f = f.groupby('trip_id').apply(fill)\n",
    "    if num_decimals is not None:\n",
    "        f[delay_col] = f[delay_col].round(num_decimals)\n",
    "\n",
    "    return f \n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>0</th>\n",
       "      <th>1</th>\n",
       "      <th>2</th>\n",
       "      <th>3</th>\n",
       "      <th>4</th>\n",
       "      <th>5</th>\n",
       "      <th>6</th>\n",
       "      <th>7</th>\n",
       "      <th>8</th>\n",
       "      <th>9</th>\n",
       "      <th>...</th>\n",
       "      <th>334149</th>\n",
       "      <th>334150</th>\n",
       "      <th>334151</th>\n",
       "      <th>334152</th>\n",
       "      <th>334153</th>\n",
       "      <th>334154</th>\n",
       "      <th>334155</th>\n",
       "      <th>334156</th>\n",
       "      <th>334157</th>\n",
       "      <th>334158</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>trip_id</th>\n",
       "      <td>1000015308-20160512154122_v40.34</td>\n",
       "      <td>1000015308-20160512154122_v40.34</td>\n",
       "      <td>1000015308-20160512154122_v40.34</td>\n",
       "      <td>1000015308-20160512154122_v40.34</td>\n",
       "      <td>1000015308-20160512154122_v40.34</td>\n",
       "      <td>1000015308-20160512154122_v40.34</td>\n",
       "      <td>1000015308-20160512154122_v40.34</td>\n",
       "      <td>1000015308-20160512154122_v40.34</td>\n",
       "      <td>1000015308-20160512154122_v40.34</td>\n",
       "      <td>1000015308-20160512154122_v40.34</td>\n",
       "      <td>...</td>\n",
       "      <td>8300032432-20160512154122_v40.34</td>\n",
       "      <td>8300032432-20160512154122_v40.34</td>\n",
       "      <td>8300032432-20160512154122_v40.34</td>\n",
       "      <td>8300032432-20160512154122_v40.34</td>\n",
       "      <td>8300032432-20160512154122_v40.34</td>\n",
       "      <td>8300032432-20160512154122_v40.34</td>\n",
       "      <td>8300032432-20160512154122_v40.34</td>\n",
       "      <td>8300032432-20160512154122_v40.34</td>\n",
       "      <td>8300032432-20160512154122_v40.34</td>\n",
       "      <td>8300032432-20160512154122_v40.34</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>arrival_time</th>\n",
       "      <td>07:00:00</td>\n",
       "      <td>07:02:10</td>\n",
       "      <td>07:02:20</td>\n",
       "      <td>07:02:30</td>\n",
       "      <td>07:02:40</td>\n",
       "      <td>07:03:03</td>\n",
       "      <td>07:03:28</td>\n",
       "      <td>07:03:38</td>\n",
       "      <td>07:03:46</td>\n",
       "      <td>07:04:02</td>\n",
       "      <td>...</td>\n",
       "      <td>12:48:15</td>\n",
       "      <td>12:49:28</td>\n",
       "      <td>12:50:41</td>\n",
       "      <td>12:51:54</td>\n",
       "      <td>12:53:07</td>\n",
       "      <td>12:54:20</td>\n",
       "      <td>12:55:30</td>\n",
       "      <td>12:56:00</td>\n",
       "      <td>13:25:00</td>\n",
       "      <td>13:30:00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>departure_time</th>\n",
       "      <td>07:00:00</td>\n",
       "      <td>07:02:10</td>\n",
       "      <td>07:02:20</td>\n",
       "      <td>07:02:30</td>\n",
       "      <td>07:02:40</td>\n",
       "      <td>07:03:03</td>\n",
       "      <td>07:03:28</td>\n",
       "      <td>07:03:38</td>\n",
       "      <td>07:03:46</td>\n",
       "      <td>07:04:02</td>\n",
       "      <td>...</td>\n",
       "      <td>12:48:15</td>\n",
       "      <td>12:49:28</td>\n",
       "      <td>12:50:41</td>\n",
       "      <td>12:51:54</td>\n",
       "      <td>12:53:07</td>\n",
       "      <td>12:55:00</td>\n",
       "      <td>12:55:30</td>\n",
       "      <td>12:56:00</td>\n",
       "      <td>13:25:00</td>\n",
       "      <td>13:30:00</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>stop_id</th>\n",
       "      <td>6920</td>\n",
       "      <td>6800</td>\n",
       "      <td>6364</td>\n",
       "      <td>6366</td>\n",
       "      <td>6182</td>\n",
       "      <td>6156</td>\n",
       "      <td>6319</td>\n",
       "      <td>6306</td>\n",
       "      <td>6308</td>\n",
       "      <td>6313</td>\n",
       "      <td>...</td>\n",
       "      <td>8418</td>\n",
       "      <td>8420</td>\n",
       "      <td>8422</td>\n",
       "      <td>8424</td>\n",
       "      <td>8426</td>\n",
       "      <td>8428</td>\n",
       "      <td>8430</td>\n",
       "      <td>8432</td>\n",
       "      <td>2006</td>\n",
       "      <td>2010</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>stop_sequence</th>\n",
       "      <td>1</td>\n",
       "      <td>2</td>\n",
       "      <td>3</td>\n",
       "      <td>4</td>\n",
       "      <td>5</td>\n",
       "      <td>6</td>\n",
       "      <td>7</td>\n",
       "      <td>8</td>\n",
       "      <td>9</td>\n",
       "      <td>10</td>\n",
       "      <td>...</td>\n",
       "      <td>16</td>\n",
       "      <td>17</td>\n",
       "      <td>18</td>\n",
       "      <td>19</td>\n",
       "      <td>20</td>\n",
       "      <td>21</td>\n",
       "      <td>22</td>\n",
       "      <td>23</td>\n",
       "      <td>24</td>\n",
       "      <td>25</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>stop_headsign</th>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>pickup_type</th>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>drop_off_type</th>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>...</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>shape_dist_traveled</th>\n",
       "      <td>0</td>\n",
       "      <td>1.1846</td>\n",
       "      <td>1.4745</td>\n",
       "      <td>1.74088</td>\n",
       "      <td>2.01381</td>\n",
       "      <td>2.28962</td>\n",
       "      <td>2.88646</td>\n",
       "      <td>3.13798</td>\n",
       "      <td>3.45216</td>\n",
       "      <td>3.65087</td>\n",
       "      <td>...</td>\n",
       "      <td>6.34519</td>\n",
       "      <td>6.7551</td>\n",
       "      <td>7.11309</td>\n",
       "      <td>7.32066</td>\n",
       "      <td>7.71901</td>\n",
       "      <td>8.00679</td>\n",
       "      <td>8.40636</td>\n",
       "      <td>8.62261</td>\n",
       "      <td>23.0881</td>\n",
       "      <td>24.2706</td>\n",
       "    </tr>\n",
       "    <tr>\n",
<<<<<<< HEAD
       "      <th>delay</th>\n",
       "      <td>0</td>\n",
=======
       "      <th>arrival_delay</th>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>200</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>376</td>\n",
       "      <td>...</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>-1291</td>\n",
       "      <td>-852</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>departure_delay</th>\n",
       "      <td>NaN</td>\n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "      <td>108</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>151</td>\n",
       "      <td>208</td>\n",
       "      <td>NaN</td>\n",
       "      <td>337</td>\n",
       "      <td>NaN</td>\n",
       "      <td>398</td>\n",
       "      <td>...</td>\n",
<<<<<<< HEAD
       "      <td>-249</td>\n",
       "      <td>-263</td>\n",
       "      <td>-275</td>\n",
       "      <td>-282</td>\n",
       "      <td>-295</td>\n",
       "      <td>-305</td>\n",
       "      <td>-318</td>\n",
       "      <td>-326</td>\n",
       "      <td>-812</td>\n",
       "      <td>-852</td>\n",
=======
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaN</td>\n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "<p>10 rows Ã— 334159 columns</p>\n",
       "</div>"
      ],
      "text/plain": [
       "                                               0       \\\n",
       "trip_id              1000015308-20160512154122_v40.34   \n",
       "arrival_time                                 07:00:00   \n",
       "departure_time                               07:00:00   \n",
       "stop_id                                          6920   \n",
       "stop_sequence                                       1   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                     NaN   \n",
       "shape_dist_traveled                                 0   \n",
<<<<<<< HEAD
       "delay                                               0   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   NaN   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               1       \\\n",
       "trip_id              1000015308-20160512154122_v40.34   \n",
       "arrival_time                                 07:02:10   \n",
       "departure_time                               07:02:10   \n",
       "stop_id                                          6800   \n",
       "stop_sequence                                       2   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                     NaN   \n",
       "shape_dist_traveled                            1.1846   \n",
<<<<<<< HEAD
       "delay                                             108   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   108   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               2       \\\n",
       "trip_id              1000015308-20160512154122_v40.34   \n",
       "arrival_time                                 07:02:20   \n",
       "departure_time                               07:02:20   \n",
       "stop_id                                          6364   \n",
       "stop_sequence                                       3   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                     NaN   \n",
       "shape_dist_traveled                            1.4745   \n",
<<<<<<< HEAD
       "delay                                             123   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   NaN   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               3       \\\n",
       "trip_id              1000015308-20160512154122_v40.34   \n",
       "arrival_time                                 07:02:30   \n",
       "departure_time                               07:02:30   \n",
       "stop_id                                          6366   \n",
       "stop_sequence                                       4   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                     NaN   \n",
       "shape_dist_traveled                           1.74088   \n",
<<<<<<< HEAD
       "delay                                             137   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   NaN   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               4       \\\n",
       "trip_id              1000015308-20160512154122_v40.34   \n",
       "arrival_time                                 07:02:40   \n",
       "departure_time                               07:02:40   \n",
       "stop_id                                          6182   \n",
       "stop_sequence                                       5   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                     NaN   \n",
       "shape_dist_traveled                           2.01381   \n",
<<<<<<< HEAD
       "delay                                             151   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   151   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               5       \\\n",
       "trip_id              1000015308-20160512154122_v40.34   \n",
       "arrival_time                                 07:03:03   \n",
       "departure_time                               07:03:03   \n",
       "stop_id                                          6156   \n",
       "stop_sequence                                       6   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                     NaN   \n",
       "shape_dist_traveled                           2.28962   \n",
       "delay                                             208   \n",
       "\n",
       "                                               6       \\\n",
       "trip_id              1000015308-20160512154122_v40.34   \n",
       "arrival_time                                 07:03:28   \n",
       "departure_time                               07:03:28   \n",
       "stop_id                                          6319   \n",
       "stop_sequence                                       7   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                     NaN   \n",
       "shape_dist_traveled                           2.88646   \n",
<<<<<<< HEAD
       "delay                                             299   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   NaN   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               7       \\\n",
       "trip_id              1000015308-20160512154122_v40.34   \n",
       "arrival_time                                 07:03:38   \n",
       "departure_time                               07:03:38   \n",
       "stop_id                                          6306   \n",
       "stop_sequence                                       8   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                     NaN   \n",
       "shape_dist_traveled                           3.13798   \n",
<<<<<<< HEAD
       "delay                                             337   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   337   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               8       \\\n",
       "trip_id              1000015308-20160512154122_v40.34   \n",
       "arrival_time                                 07:03:46   \n",
       "departure_time                               07:03:46   \n",
       "stop_id                                          6308   \n",
       "stop_sequence                                       9   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                     NaN   \n",
       "shape_dist_traveled                           3.45216   \n",
<<<<<<< HEAD
       "delay                                             374   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   NaN   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               9       \\\n",
       "trip_id              1000015308-20160512154122_v40.34   \n",
       "arrival_time                                 07:04:02   \n",
       "departure_time                               07:04:02   \n",
       "stop_id                                          6313   \n",
       "stop_sequence                                      10   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                     NaN   \n",
       "shape_dist_traveled                           3.65087   \n",
       "delay                                             398   \n",
       "\n",
       "                                   ...                 \\\n",
       "trip_id                            ...                  \n",
       "arrival_time                       ...                  \n",
       "departure_time                     ...                  \n",
       "stop_id                            ...                  \n",
       "stop_sequence                      ...                  \n",
       "stop_headsign                      ...                  \n",
       "pickup_type                        ...                  \n",
       "drop_off_type                      ...                  \n",
       "shape_dist_traveled                ...                  \n",
       "delay                              ...                  \n",
       "\n",
       "                                               334149  \\\n",
       "trip_id              8300032432-20160512154122_v40.34   \n",
       "arrival_time                                 12:48:15   \n",
       "departure_time                               12:48:15   \n",
       "stop_id                                          8418   \n",
       "stop_sequence                                      16   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                       1   \n",
       "shape_dist_traveled                           6.34519   \n",
<<<<<<< HEAD
       "delay                                            -249   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   NaN   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               334150  \\\n",
       "trip_id              8300032432-20160512154122_v40.34   \n",
       "arrival_time                                 12:49:28   \n",
       "departure_time                               12:49:28   \n",
       "stop_id                                          8420   \n",
       "stop_sequence                                      17   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                       1   \n",
       "shape_dist_traveled                            6.7551   \n",
<<<<<<< HEAD
       "delay                                            -263   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   NaN   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               334151  \\\n",
       "trip_id              8300032432-20160512154122_v40.34   \n",
       "arrival_time                                 12:50:41   \n",
       "departure_time                               12:50:41   \n",
       "stop_id                                          8422   \n",
       "stop_sequence                                      18   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                       1   \n",
       "shape_dist_traveled                           7.11309   \n",
<<<<<<< HEAD
       "delay                                            -275   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   NaN   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               334152  \\\n",
       "trip_id              8300032432-20160512154122_v40.34   \n",
       "arrival_time                                 12:51:54   \n",
       "departure_time                               12:51:54   \n",
       "stop_id                                          8424   \n",
       "stop_sequence                                      19   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                       1   \n",
       "shape_dist_traveled                           7.32066   \n",
<<<<<<< HEAD
       "delay                                            -282   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   NaN   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               334153  \\\n",
       "trip_id              8300032432-20160512154122_v40.34   \n",
       "arrival_time                                 12:53:07   \n",
       "departure_time                               12:53:07   \n",
       "stop_id                                          8426   \n",
       "stop_sequence                                      20   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                       1   \n",
       "shape_dist_traveled                           7.71901   \n",
<<<<<<< HEAD
       "delay                                            -295   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   NaN   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               334154  \\\n",
       "trip_id              8300032432-20160512154122_v40.34   \n",
       "arrival_time                                 12:54:20   \n",
       "departure_time                               12:55:00   \n",
       "stop_id                                          8428   \n",
       "stop_sequence                                      21   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                       1   \n",
       "shape_dist_traveled                           8.00679   \n",
<<<<<<< HEAD
       "delay                                            -305   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   NaN   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               334155  \\\n",
       "trip_id              8300032432-20160512154122_v40.34   \n",
       "arrival_time                                 12:55:30   \n",
       "departure_time                               12:55:30   \n",
       "stop_id                                          8430   \n",
       "stop_sequence                                      22   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                       1   \n",
       "shape_dist_traveled                           8.40636   \n",
<<<<<<< HEAD
       "delay                                            -318   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   NaN   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               334156  \\\n",
       "trip_id              8300032432-20160512154122_v40.34   \n",
       "arrival_time                                 12:56:00   \n",
       "departure_time                               12:56:00   \n",
       "stop_id                                          8432   \n",
       "stop_sequence                                      23   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                       NaN   \n",
       "drop_off_type                                       1   \n",
       "shape_dist_traveled                           8.62261   \n",
<<<<<<< HEAD
       "delay                                            -326   \n",
=======
       "arrival_delay                                     NaN   \n",
       "departure_delay                                   NaN   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               334157  \\\n",
       "trip_id              8300032432-20160512154122_v40.34   \n",
       "arrival_time                                 13:25:00   \n",
       "departure_time                               13:25:00   \n",
       "stop_id                                          2006   \n",
       "stop_sequence                                      24   \n",
       "stop_headsign                                     NaN   \n",
       "pickup_type                                         1   \n",
       "drop_off_type                                     NaN   \n",
       "shape_dist_traveled                           23.0881   \n",
<<<<<<< HEAD
       "delay                                            -812   \n",
=======
       "arrival_delay                                   -1291   \n",
       "departure_delay                                   NaN   \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "                                               334158  \n",
       "trip_id              8300032432-20160512154122_v40.34  \n",
       "arrival_time                                 13:30:00  \n",
       "departure_time                               13:30:00  \n",
       "stop_id                                          2010  \n",
       "stop_sequence                                      25  \n",
       "stop_headsign                                     NaN  \n",
       "pickup_type                                         1  \n",
       "drop_off_type                                     NaN  \n",
       "shape_dist_traveled                           24.2706  \n",
<<<<<<< HEAD
       "delay                                            -852  \n",
=======
       "arrival_delay                                    -852  \n",
       "departure_delay                                   NaN  \n",
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
       "\n",
       "[10 rows x 334159 columns]"
      ]
     },
<<<<<<< HEAD
     "execution_count": 12,
=======
     "execution_count": 19,
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Clean delays \n",
    "delays = pd.read_csv(DATA_DIR/'delays_{0}.csv.gz'.format(date), \n",
    "  compression='gzip', dtype={'stop_id': str, 'stop_sequence': int})\n",
    "\n",
    "delays = clean_delays(delays)\n",
    "\n",
    "# Concatenate delays and stop times\n",
    "f = gt.get_stop_times(feed, date)\n",
    "f = f.merge(delays, how='left')\n",
    "\n",
<<<<<<< HEAD
    "# Interpolate delays\n",
    "for delay_col in ['delay']:\n",
    "    f = interpolate_delays(f, dist_threshold=0.5)\n",
    "\n",
=======
>>>>>>> e832a1e791c106b733a242f4785ea9c2c0e10914
    "# Write to file\n",
    "path = DATA_DIR/'augmented_stop_times_{0}.csv.gz'.format(date)\n",
    "f.to_csv(str(path), index=False, compression='gzip')\n",
    "\n",
    "f.T\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "metadata": {
    "collapsed": false
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "182772 334159 0.546961177164\n"
     ]
    }
   ],
   "source": [
    "a = f['delay'].count()\n",
    "b = f['delay'].shape[0]\n",
    "print(a, b, a/b)"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.4.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 0
}
